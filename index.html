<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surya Namaskar - Sun Salutation App</title>

       <!-- PWA Meta Tags (Replaces manifest.json link) -->
       <meta name="application-name" content="Surya Namaskar App">
       <meta name="description" content="Guided practice and guide for Surya Namaskar (Sun Salutation).">
       <meta name="mobile-web-app-capable" content="yes">
       <meta name="apple-mobile-web-app-capable"="yes">
       <meta name="apple-mobile-web-app-status-bar-style"="black"> <!-- Changed to black for seamless look -->
       <meta name="apple-mobile-web-app-title" content="SuryaNamaskar">
       <meta name="theme-color" content="#f97316"> <!-- Orange-500 -->
       <link rel="icon" type="image/png" sizes="192x192" href="icon.png"> <!-- Standard icon -->
       <link rel="apple-touch-icon" href="icon.png"> <!-- iOS icon -->
       <!-- You can add more icon sizes if needed -->
       <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Dark mode variables */
        :root {
            --bg-primary: #f9fafb;
            --bg-secondary: #ffffff;
            --bg-accent: #f3f4f6;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --accent-color: #f97316;
            --accent-hover: #ea580c;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        
        /* Dark mode theme */
        [data-theme="dark"] {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-accent: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #d1d5db;
            --accent-color: #f97316;
            --accent-hover: #fb923c;
            --border-color: #374151;
            --shadow-color: rgba(0, 0, 0, 0.5);
        }
        
        /* Apply theme variables */
        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        /* Apply background colors to all relevant elements */
        .bg-white, .bg-gray-50, .bg-gray-100, 
        .pose-card, .max-w-md, header + div,
        .rounded-lg, .shadow, .shadow-lg {
            background-color: var(--bg-secondary) !important;
            transition: background-color 0.3s ease;
            border-color: var(--border-color);
        }
        
        /* Fix blue info boxes in dark mode */
        [data-theme="dark"] .bg-blue-50 {
            background-color: rgba(30, 58, 138, 0.3) !important; /* dark blue */
        }
        
        [data-theme="dark"] .text-blue-700,
        [data-theme="dark"] .text-blue-800 {
            color: #93c5fd !important; /* lighter blue for dark mode */
        }
        
        /* Fix text colors for better readability in dark mode */
        .text-gray-800, .text-gray-700, .text-gray-600 {
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        .text-gray-500 {
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        /* Ensure dark mode has white text for better contrast */
        [data-theme="dark"] .text-gray-800, 
        [data-theme="dark"] .text-gray-700, 
        [data-theme="dark"] .text-gray-600 {
            color: #f3f4f6 !important; /* Light gray, almost white */
        }
        
        [data-theme="dark"] .text-gray-500 {
            color: #d1d5db !important; /* Lighter gray */
        }
        
        /* Fix borders in dark mode */
        [data-theme="dark"] .border,
        [data-theme="dark"] .border-b,
        [data-theme="dark"] .border-t,
        [data-theme="dark"] .border-l,
        [data-theme="dark"] .border-r {
            border-color: var(--border-color);
        }
        
        /* Ensure header stays colorful in both modes */
        header.bg-gradient-to-r {
            background: linear-gradient(to right, #f97316, #facc15) !important;
        }
        
        /* Header styles */
        header.compact-header {
            padding: 0.5rem !important;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        header.compact-header h1 {
            font-size: 1.25rem !important;
            margin: 0;
        }
        
        /* Hide header subtitle on compact mode */
        header.compact-header p {
            display: none;
        }
        
        /* Tab content styles */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Pose image styles - INCREASED HEIGHT for mobile */
        .pose-image {
            transition: transform 0.3s ease;
            max-height: 280px; /* Increased from 220px for better mobile viewing */
            height: auto; /* Allow natural aspect ratio */
            object-fit: cover;
            width: 100%;
            display: block; /* Ensure it takes full width */
        }
        .pose-image:hover {
            transform: scale(1.05);
        }
        
        /* Progress bar */
        .progress-bar {
            height: 6px;
            transition: width 0.5s linear;
        }
        
        /* Pose cards */
        .current-pose-card {
            transform: scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(249, 115, 22, 0.2), 0 4px 6px -2px rgba(249, 115, 22, 0.1); /* Orange glow */
            border: 1px solid var(--accent-color);
        }
        .next-pose-card {
            opacity: 0.8;
        }
        
        /* Video container */
        #videoContainer {
            position: relative;
            padding-bottom: 56.25%; /* 16:9 aspect ratio */
            height: 0;
            overflow: hidden;
        }
        #videoContainer iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        /* Range input styling */
        input[type=range] {
            height: 6px;
            cursor: pointer;
            appearance: none;
            width: 100%;
            background: var(--border-color);
            border-radius: 9999px;
            outline: none;
        }
        input[type=range]::-webkit-slider-thumb {
            appearance: none;
            width: 16px;
            height: 16px;
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
        }
        input[type=range]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            background: var(--accent-color);
            cursor: pointer;
            border-radius: 50%;
            border: none;
        }
        
        /* Image container styles */
        .pose-image-container {
            min-height: 280px; /* Match max-height of image - INCREASED */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 0.5rem;
            background-color: var(--bg-accent);
        }
        
        /* Dark mode toggle */
        .theme-toggle {
            position: absolute; /* Changed from fixed to absolute */
            top: 15px;
            right: 15px;
            z-index: 100;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px var(--shadow-color);
            transition: all 0.3s ease;
            color: var(--text-primary);
        }
        
        .theme-toggle:hover {
            transform: scale(1.1);
            background-color: var(--accent-color);
            color: white;
        }
        
        [data-theme="dark"] .theme-toggle {
            background-color: var(--bg-accent);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        }
        
        [data-theme="dark"] .theme-toggle:hover {
            background-color: var(--accent-color);
        }
        
        /* Video link styles */
        .video-link {
            display: block;
            padding: 12px;
            border-radius: 8px;
            background-color: var(--bg-accent);
            color: var(--text-primary);
            text-decoration: none;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }
        
        .video-link:hover {
            background-color: var(--accent-color);
            color: white;
        }
        
        /* Additional dark mode specific styles */
        [data-theme="dark"] #app-container {
            background-color: var(--bg-secondary);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        [data-theme="dark"] .pose-card {
            background-color: var(--bg-accent) !important;
        }
        
        [data-theme="dark"] .pose-image-container {
            background-color: rgba(0, 0, 0, 0.2);
        }
        
        /* Dark mode styles for practice page */
        [data-theme="dark"] .current-pose-card {
            background-color: rgba(249, 115, 22, 0.15) !important;
        }
        
        [data-theme="dark"] .next-pose-card {
            background-color: var(--bg-accent) !important;
        }
        
        [data-theme="dark"] .bg-orange-100 {
            background-color: rgba(249, 115, 22, 0.2) !important;
        }
        
        [data-theme="dark"] #current-pose-instruction,
        [data-theme="dark"] #next-pose-instruction {
            color: #e5e7eb !important;
        }
        
        [data-theme="dark"] #current-breathing-cue {
            color: #fdba74 !important; /* Light orange */
        }
        
        [data-theme="dark"] .tab-btn {
            color: var(--text-secondary);
        }
        
        [data-theme="dark"] .tab-btn.text-orange-600 {
            color: var(--accent-color) !important;
        }
        
        [data-theme="dark"] input[type=range] {
            background-color: var(--bg-accent);
        }
        
        [data-theme="dark"] .video-link {
            background-color: var(--bg-accent);
        }
        
        [data-theme="dark"] .video-link:hover {
            background-color: var(--accent-color);
        }
        
        /* Practice controls layout */
        .practice-controls {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }
        
        .practice-controls button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all 0.3s ease;
        }
        
        .practice-controls .timer-container {
            text-align: center;
        }
        
        /* Media queries for responsive design */
        @media (max-width: 640px) {
            .pose-image {
                max-height: 250px; /* Slightly smaller on very small screens */
            }
            .pose-image-container {
                min-height: 250px;
            }
        }

        /* Add position relative to header to contain the absolute positioned toggle */
        header {
            position: relative;
        }
    </style>
</head>
<body class="bg-gray-50 font-sans" data-theme="light">
    <div class="max-w-md mx-auto shadow-lg rounded-b-xl overflow-hidden mb-10" id="app-container">
        <!-- Modern Header with 3D Effect -->
        <header class="bg-gradient-to-r from-orange-500 via-orange-400 to-yellow-400 p-4 text-center compact-header relative overflow-hidden shadow-lg">
            <!-- Decorative Sun Icon -->
            <div class="absolute -top-6 -right-6 w-24 h-24 rounded-full bg-yellow-300 opacity-20 blur-md"></div>
            <div class="absolute -bottom-6 -left-6 w-16 h-16 rounded-full bg-orange-600 opacity-20 blur-md"></div>
            
            <!-- Dark Mode Toggle Button -->
            <button id="theme-toggle" class="theme-toggle z-10" aria-label="Toggle dark mode">
                <i id="theme-icon" class="fas fa-moon"></i>
            </button>
            
            <div class="relative z-10">
                <h1 class="text-2xl font-bold text-white drop-shadow-md tracking-wide">Surya Namaskar</h1>
                <p class="text-white text-opacity-90 text-sm mt-1 font-medium">Sun Salutation Practice</p>
            </div>
        </header>

        <!-- Modernized Tabs Navigation -->
        <div class="flex border-b bg-gradient-to-r from-orange-50 to-yellow-50 dark:from-gray-800 dark:to-gray-700 rounded-t-lg overflow-hidden">
            <button class="tab-btn flex-1 py-4 px-4 text-center font-medium text-orange-600 border-b-2 border-orange-500 transition-all duration-300 hover:bg-orange-100 dark:hover:bg-gray-600 flex flex-col items-center" data-tab="pose-guide">
                <i class="fas fa-book-open text-lg mb-1"></i><span class="text-xs sm:text-sm">Guide</span>
            </button>
            <button class="tab-btn flex-1 py-4 px-4 text-center font-medium text-gray-500 border-b-2 border-transparent transition-all duration-300 hover:bg-orange-100 dark:hover:bg-gray-600 flex flex-col items-center" data-tab="guided-practice">
                <i class="fas fa-dumbbell text-lg mb-1"></i><span class="text-xs sm:text-sm">Practice</span>
            </button>
            <button class="tab-btn flex-1 py-4 px-4 text-center font-medium text-gray-500 border-b-2 border-transparent transition-all duration-300 hover:bg-orange-100 dark:hover:bg-gray-600 flex flex-col items-center" data-tab="timing">
                <i class="fas fa-clock text-lg mb-1"></i><span class="text-xs sm:text-sm">Timing</span>
            </button>
            <button class="tab-btn flex-1 py-4 px-4 text-center font-medium text-gray-500 border-b-2 border-transparent transition-all duration-300 hover:bg-orange-100 dark:hover:bg-gray-600 flex flex-col items-center" data-tab="video">
                <i class="fas fa-video text-lg mb-1"></i><span class="text-xs sm:text-sm">Video</span>
            </button>
            <!-- Stats Tab -->
            <button class="tab-btn flex-1 py-4 px-4 text-center font-medium text-gray-500 border-b-2 border-transparent transition-all duration-300 hover:bg-orange-100 dark:hover:bg-gray-600 flex flex-col items-center" data-tab="stats">
                <i class="fas fa-chart-bar text-lg mb-1"></i><span class="text-xs sm:text-sm">Stats</span>
            </button>
        </div>

        <!-- Tab Contents -->
        <div class="p-4">
            <!-- Pose Guide Tab -->
            <div id="pose-guide" class="tab-content active">
                <div class="flex items-center justify-between mb-5">
                    <h2 class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-orange-500 to-yellow-600">12 Steps of Surya Namaskar</h2>
                    <div class="text-xs text-gray-500 bg-gray-100 dark:bg-gray-700 px-3 py-1 rounded-full">
                        <i class="fas fa-info-circle mr-1"></i> Swipe to explore
                    </div>
                </div>

                <div class="space-y-5">
                    <!-- Pose 1: Pranamasana -->
                    <div class="bg-gradient-to-br from-gray-50 to-white dark:from-gray-800 dark:to-gray-700 p-4 rounded-xl shadow-md pose-card border border-gray-100 dark:border-gray-600 transition-all duration-300 hover:shadow-lg transform hover:scale-[1.01]">
                        <div class="flex items-center mb-3">
                            <div class="bg-gradient-to-br from-orange-100 to-yellow-100 dark:from-orange-500 dark:to-orange-600 dark:bg-opacity-30 text-orange-800 dark:text-orange-100 rounded-full w-9 h-9 flex items-center justify-center font-bold mr-3 flex-shrink-0 shadow-sm">1</div>
                            <h3 class="text-md font-semibold text-gray-800 dark:text-gray-100">Pranamasana <span class="text-sm text-gray-500 dark:text-gray-400">(Prayer Pose)</span></h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <div class="sm:w-1/3 flex-shrink-0 pose-image-container rounded-lg overflow-hidden shadow-sm"> 
                                <img src="assets/Surya-Namaskar-step-1.jpg" alt="Pranamasana" class="pose-image"> 
                            </div>
                            <div class="sm:w-2/3">
                                <p class="text-sm text-gray-600 dark:text-gray-300 leading-relaxed">Stand erect, feet together. Join palms at chest center. Relax, focus inwards.</p>
                                <div class="mt-2 text-sm bg-orange-50 dark:bg-gray-600 p-2 rounded-lg inline-flex items-center">
                                    <i class="fas fa-wind mr-2 text-orange-500"></i>
                                    <span class="font-medium text-orange-700 dark:text-orange-300">Breathing:</span> 
                                    <span class="ml-1 text-orange-600 dark:text-orange-200">Normal or Exhale</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pose 2: Hasta Uttanasana -->
                    <div class="bg-gray-50 p-3 rounded-lg shadow pose-card">
                         <div class="flex items-center mb-2">
                            <div class="bg-orange-100 text-orange-800 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 flex-shrink-0">2</div>
                            <h3 class="text-md font-semibold text-gray-800">Hasta Uttanasana (Raised Arms)</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="sm:w-1/3 flex-shrink-0 pose-image-container"> 
                                <img src="assets/Surya-Namaskar-step-2.jpg" alt="Hasta Uttanasana" class="pose-image">
                            </div>
                            <div class="sm:w-2/3">
                                <p class="text-sm text-gray-600">Raise arms overhead, arch back gently from upper back, push hips slightly forward. Keep arms beside ears.</p>
                                <div class="mt-1 text-xs text-orange-600">
                                    <span class="font-medium">Breathing:</span> Inhale.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pose 3: Hasta Padasana -->
                    <div class="bg-gray-50 p-3 rounded-lg shadow pose-card">
                         <div class="flex items-center mb-2">
                            <div class="bg-orange-100 text-orange-800 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 flex-shrink-0">3</div>
                            <h3 class="text-md font-semibold text-gray-800">Hasta Padasana (Hand to Foot)</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="sm:w-1/3 flex-shrink-0 pose-image-container"> 
                                <img src="assets/Surya-Namaskar-step-3.jpg" alt="Hasta Padasana" class="pose-image">
                            </div>
                            <div class="sm:w-2/3">
                                <p class="text-sm text-gray-600">Bend forward from hips, spine straight. Bring hands down beside feet. Try to touch forehead to knees (bend knees if needed).</p>
                                <div class="mt-1 text-xs text-orange-600">
                                    <span class="font-medium">Breathing:</span> Exhale.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pose 4: Ashwa Sanchalanasana -->
                    <div class="bg-gray-50 p-3 rounded-lg shadow pose-card">
                         <div class="flex items-center mb-2">
                            <div class="bg-orange-100 text-orange-800 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 flex-shrink-0">4</div>
                            <h3 class="text-md font-semibold text-gray-800">Ashwa Sanchalanasana (Equestrian)</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="sm:w-1/3 flex-shrink-0 pose-image-container"> 
                                <img src="assets/Surya-Namaskar-step-4.jpg" alt="Ashwa Sanchalanasana" class="pose-image">
                            </div>
                            <div class="sm:w-2/3">
                                <p class="text-sm text-gray-600">Stretch right leg back, knee on floor. Left knee between hands, bent at 90Â°. Look up, arch spine slightly.</p>
                                <div class="mt-1 text-xs text-orange-600">
                                    <span class="font-medium">Breathing:</span> Inhale.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pose 5: Parvatasana -->
                    <div class="bg-gray-50 p-3 rounded-lg shadow pose-card">
                         <div class="flex items-center mb-2">
                            <div class="bg-orange-100 text-orange-800 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 flex-shrink-0">5</div>
                            <h3 class="text-md font-semibold text-gray-800">Parvatasana (Mountain)</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="sm:w-1/3 flex-shrink-0 pose-image-container"> 
                                <img src="assets/Surya-Namaskar-step-5.jpg" alt="Parvatasana" class="pose-image">
                            </div>
                            <div class="sm:w-2/3">
                                <p class="text-sm text-gray-600">Bring left leg back beside right. Lift hips up, push heels towards floor (inverted V). Head between arms.</p>
                                <div class="mt-1 text-xs text-orange-600">
                                    <span class="font-medium">Breathing:</span> Exhale.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pose 6: Ashtanga Namaskara -->
                    <div class="bg-gray-50 p-3 rounded-lg shadow pose-card">
                         <div class="flex items-center mb-2">
                            <div class="bg-orange-100 text-orange-800 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 flex-shrink-0">6</div>
                            <h3 class="text-md font-semibold text-gray-800">Ashtanga Namaskara (Eight Limbs)</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="sm:w-1/3 flex-shrink-0 pose-image-container"> 
                                <img src="assets/Surya-Namaskar-step-6.jpg" alt="Ashtanga Namaskara" class="pose-image">
                            </div>
                            <div class="sm:w-2/3">
                                <p class="text-sm text-gray-600">Lower knees, chest, and chin to floor. Hips remain slightly elevated. Eight points touch: feet, knees, hands, chest, chin.</p>
                                <div class="mt-1 text-xs text-orange-600">
                                    <span class="font-medium">Breathing:</span> Hold breath.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pose 7: Bhujangasana -->
                    <div class="bg-gray-50 p-3 rounded-lg shadow pose-card">
                         <div class="flex items-center mb-2">
                            <div class="bg-orange-100 text-orange-800 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 flex-shrink-0">7</div>
                            <h3 class="text-md font-semibold text-gray-800">Bhujangasana (Cobra)</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="sm:w-1/3 flex-shrink-0 pose-image-container"> 
                                <img src="assets/Surya-Namaskar-step-7.jpg" alt="Bhujangasana" class="pose-image">
                            </div>
                            <div class="sm:w-2/3">
                                <p class="text-sm text-gray-600">Slide forward, raise chest using back muscles (minimal hand pressure). Elbows bent, close to body. Look up.</p>
                                <div class="mt-1 text-xs text-orange-600">
                                    <span class="font-medium">Breathing:</span> Inhale.
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pose 8: Parvatasana -->
                    <div class="bg-gray-50 p-3 rounded-lg shadow pose-card">
                         <div class="flex items-center mb-2">
                            <div class="bg-orange-100 text-orange-800 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 flex-shrink-0">8</div>
                            <h3 class="text-md font-semibold text-gray-800">Parvatasana (Mountain)</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="sm:w-1/3 flex-shrink-0 pose-image-container"> 
                                <img src="assets/Surya-Namaskar-step-5.jpg" alt="Parvatasana" class="pose-image">
                            </div>
                             <div class="sm:w-2/3">
                                <p class="text-sm text-gray-600">Lift hips up, push heels towards floor (inverted V). Head between arms. Same as Pose 5.</p>
                                <div class="mt-1 text-xs text-orange-600">
                                    <span class="font-medium">Breathing:</span> Exhale.
                                </div>
                            </div>
                        </div>
                    </div>

                     <!-- Pose 9: Ashwa Sanchalanasana -->
                    <div class="bg-gray-50 p-3 rounded-lg shadow pose-card">
                         <div class="flex items-center mb-2">
                            <div class="bg-orange-100 text-orange-800 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 flex-shrink-0">9</div>
                            <h3 class="text-md font-semibold text-gray-800">Ashwa Sanchalanasana (Equestrian)</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="sm:w-1/3 flex-shrink-0 pose-image-container"> 
                                <img src="assets/Surya-Namaskar-step-9.jpg" alt="Ashwa Sanchalanasana" class="pose-image">
                            </div>
                            <div class="sm:w-2/3">
                                <p class="text-sm text-gray-600">Bring right foot forward between hands. Left knee on floor. Look up. Same as Pose 4, leading with the opposite leg.</p>
                                <div class="mt-1 text-xs text-orange-600">
                                    <span class="font-medium">Breathing:</span> Inhale.
                                </div>
                            </div>
                        </div>
                    </div>

                     <!-- Pose 10: Hasta Padasana -->
                    <div class="bg-gray-50 p-3 rounded-lg shadow pose-card">
                         <div class="flex items-center mb-2">
                            <div class="bg-orange-100 text-orange-800 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 flex-shrink-0">10</div>
                            <h3 class="text-md font-semibold text-gray-800">Hasta Padasana (Hand to Foot)</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="sm:w-1/3 flex-shrink-0 pose-image-container"> 
                                <img src="assets/Surya-Namaskar-step-3.jpg" alt="Hasta Padasana" class="pose-image">
                            </div>
                           <div class="sm:w-2/3">
                                <p class="text-sm text-gray-600">Bring left foot forward next to right. Bend forward from hips. Same as Pose 3.</p>
                                <div class="mt-1 text-xs text-orange-600">
                                    <span class="font-medium">Breathing:</span> Exhale.
                                </div>
                            </div>
                        </div>
                    </div>

                     <!-- Pose 11: Hasta Uttanasana -->
                    <div class="bg-gray-50 p-3 rounded-lg shadow pose-card">
                         <div class="flex items-center mb-2">
                            <div class="bg-orange-100 text-orange-800 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 flex-shrink-0">11</div>
                            <h3 class="text-md font-semibold text-gray-800">Hasta Uttanasana (Raised Arms)</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="sm:w-1/3 flex-shrink-0 pose-image-container"> 
                                <img src="assets/Surya-Namaskar-step-2.jpg" alt="Hasta Uttanasana" class="pose-image">
                            </div>
                             <div class="sm:w-2/3">
                                <p class="text-sm text-gray-600">Raise torso, lift arms overhead, arch back gently. Same as Pose 2.</p>
                                <div class="mt-1 text-xs text-orange-600">
                                    <span class="font-medium">Breathing:</span> Inhale.
                                </div>
                            </div>
                        </div>
                    </div>

                     <!-- Pose 12: Pranamasana -->
                    <div class="bg-gray-50 p-3 rounded-lg shadow pose-card">
                         <div class="flex items-center mb-2">
                            <div class="bg-orange-100 text-orange-800 rounded-full w-8 h-8 flex items-center justify-center font-bold mr-3 flex-shrink-0">12</div>
                            <h3 class="text-md font-semibold text-gray-800">Pranamasana (Prayer Pose)</h3>
                        </div>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <div class="sm:w-1/3 flex-shrink-0 pose-image-container"> 
                                <img src="assets/Surya-Namaskar-step-1.jpg" alt="Pranamasana" class="pose-image">
                            </div>
                             <div class="sm:w-2/3">
                                <p class="text-sm text-gray-600">Bring arms down, join palms at chest center. Return to starting position. Same as Pose 1.</p>
                                <div class="mt-1 text-xs text-orange-600">
                                    <span class="font-medium">Breathing:</span> Exhale.
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Guided Practice Tab -->
            <div id="guided-practice" class="tab-content">
                <div class="practice-controls bg-gradient-to-r from-orange-50 to-yellow-50 dark:from-gray-800 dark:to-gray-700 p-4 rounded-xl shadow-md mb-6">
                    <button id="play-pause-btn" class="bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white transition duration-300 shadow-lg transform hover:scale-105 active:scale-95">
                        <i class="fas fa-play" id="play-pause-icon"></i>
                    </button>
                    
                    <div class="timer-container">
                        <div class="text-5xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-orange-500 to-orange-600 mb-2" id="timer">05</div>
                        <div class="text-sm text-gray-600 dark:text-gray-300 mb-1 font-medium">Time Remaining in Pose</div>
                        <div class="text-gray-600 dark:text-gray-300">Round: <span id="round-count" class="font-medium text-orange-600 dark:text-orange-400">1</span>/<span id="total-rounds-display" class="font-medium">5</span></div>
                        <div class="w-full bg-gray-200 dark:bg-gray-600 rounded-full h-3 mt-3 shadow-inner">
                            <div class="progress-bar bg-gradient-to-r from-orange-400 to-orange-600 h-3 rounded-full shadow-sm" style="width: 100%" id="pose-progress"></div>
                        </div>
                    </div>
                    
                    <button id="reset-btn" class="bg-gradient-to-r from-gray-500 to-gray-600 hover:from-gray-600 hover:to-gray-700 text-white transition duration-300 shadow-lg transform hover:scale-105 active:scale-95">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>

                <!-- Improved Practice UI with Current Pose Prominence -->
                <div class="mb-6">
                    <!-- Current Pose - Full Width and Larger -->
                    <div class="bg-gradient-to-br from-orange-50 to-yellow-50 dark:from-gray-800 dark:to-gray-700 p-5 rounded-2xl shadow-xl current-pose-card mb-6 transform transition-all duration-300 border border-orange-100 dark:border-gray-600">
                        <div class="flex justify-between items-center mb-3">
                            <div class="bg-orange-100 dark:bg-gray-600 px-3 py-1 rounded-full">
                                <h3 class="text-sm font-medium text-orange-700 dark:text-orange-300">Pose <span id="current-pose-number" class="font-bold">1</span>/12</h3>
                            </div>
                            <h2 class="text-xl font-bold text-orange-600 dark:text-orange-400" id="current-pose-name">Pranamasana</h2>
                        </div>
                        
                        <div class="pose-image-container mb-4 rounded-xl overflow-hidden shadow-md" style="min-height: 300px;"> 
                            <img src="assets/Surya-Namaskar-step-1.jpg" alt="Current Pose" class="pose-image" id="current-pose-image" style="max-height: 300px;">
                        </div>
                        
                        <!-- Special instruction container for poses 4 and 9 -->
                        <div id="special-instruction-container" class="hidden mb-3 bg-orange-600 text-white text-center py-3 rounded-lg shadow-md">
                            <h3 id="special-instruction-text" class="text-xl font-bold uppercase tracking-wider"></h3>
                        </div>
                        
                        <div class="bg-gradient-to-r from-orange-100 to-yellow-100 dark:from-gray-700 dark:to-gray-600 p-4 rounded-xl shadow-inner">
                            <div class="text-sm text-gray-700 dark:text-gray-200 mb-3 leading-relaxed" id="current-pose-instruction">Stand erect...</div>
                            
                            <div class="flex items-center text-sm text-orange-700 dark:text-orange-300 font-medium bg-white dark:bg-gray-800 p-2 rounded-lg shadow-sm">
                                <i class="fas fa-wind mr-2 text-orange-500"></i> Breathing: <span id="current-breathing-cue" class="ml-1">Exhale / Normal</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Next Pose - Smaller and Below -->
                    <div class="bg-gradient-to-br from-gray-50 to-gray-100 dark:from-gray-700 dark:to-gray-600 p-4 rounded-xl shadow-md next-pose-card border border-gray-200 dark:border-gray-500 transition-all duration-300">
                        <div class="flex justify-between items-center mb-2">
                            <div class="bg-gray-200 dark:bg-gray-500 px-2 py-0.5 rounded-full">
                                <h3 class="text-xs font-medium text-gray-600 dark:text-gray-200">Next <span id="next-pose-number" class="font-bold">2</span>/12</h3>
                            </div>
                            <h2 class="text-md font-bold text-gray-700 dark:text-gray-200" id="next-pose-name">Hasta Uttanasana</h2>
                        </div>
                        
                        <div class="flex items-center gap-4">
                            <div class="w-1/3 pose-image-container rounded-lg overflow-hidden shadow-sm" style="min-height: 100px;"> 
                                <img src="assets/Surya-Namaskar-step-2.jpg" alt="Next Pose" class="pose-image" id="next-pose-image" style="max-height: 100px;">
                            </div>
                            
                            <div class="w-2/3">
                                <div class="text-xs text-gray-600 dark:text-gray-300 mb-2 leading-relaxed" id="next-pose-instruction">Raise both arms...</div>
                                
                                <div class="text-xs text-gray-600 dark:text-gray-300 font-medium bg-white dark:bg-gray-800 p-1.5 rounded-lg shadow-sm inline-flex items-center">
                                    <i class="fas fa-wind mr-1 text-gray-500 dark:text-gray-400"></i> Next: <span id="next-breathing-cue" class="ml-1">Inhale</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-medium text-blue-800 mb-2"><i class="fas fa-info-circle mr-2"></i>Practice Tips</h3>
                    <ul class="text-sm text-blue-700 space-y-1 list-disc list-inside">
                        <li>Focus on your breathing throughout the sequence.</li>
                        <li>Move smoothly between poses.</li>
                        <li>Modify poses as needed for your flexibility.</li>
                        <li>Keep your awareness on the present moment.</li>
                    </ul>
                </div>
            </div>

            <!-- Timing Tab -->
            <div id="timing" class="tab-content">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Customize Your Practice</h2>

                <div class="bg-gray-50 p-4 rounded-lg shadow mb-6">
                    <h3 class="font-medium text-gray-700 mb-3">Pose Duration (seconds per pose)</h3>
                    <div class="space-y-4">
                         <div id="pose-sliders-container"></div>
                    </div>
                </div>

                <div class="bg-gray-50 p-4 rounded-lg shadow mb-6">
                    <h3 class="font-medium text-gray-700 mb-3">Practice Settings</h3>
                    <div class="space-y-4">
                        <div>
                            <label for="rounds-select" class="block text-sm text-gray-600 mb-1">Number of Rounds</label>
                            <select id="rounds-select" class="w-full p-2 border border-gray-300 rounded-md focus:ring-orange-500 focus:border-orange-500">
                                <option value="3">3</option>
                                <option value="5">5</option> <!-- Removed selected -->
                                <option value="10">10</option>
                                <option value="12">12</option>
                                <option value="24">24</option>
                                <option value="108">108</option> 
                            </select>
                        </div>

                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="voice-guidance" class="rounded text-orange-500 focus:ring-orange-500"> 
                                <span class="ml-2 text-sm text-gray-600">Voice Guidance</span>
                            </label>
                        </div>

                        <div>
                            <label class="flex items-center">
                                <input type="checkbox" id="transition-sounds" class="rounded text-orange-500 focus:ring-orange-500"> 
                                <span class="ml-2 text-sm text-gray-600">Transition Sounds</span>
                            </label>
                        </div>
                    </div>
                </div>

                <button id="save-settings-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-medium py-3 px-6 rounded-full transition duration-300">
                    Save Settings
                </button>
                <p id="settings-saved-msg" class="text-center text-green-600 text-sm mt-2 h-4"></p>
            </div>

            <!-- Video Tab -->
            <div id="video" class="tab-content">
              
                <h2 class="text-xl font-bold text-gray-800 mb-4">Video Demonstrations</h2>
                
                <div class="space-y-4">
                    <!-- Video Link 1 -->
                    <a href="https://youtube.com/shorts/8XLBpKnWYww?si=Pjby9t87EGcPDD_G" target="_blank" rel="noopener" class="video-link">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 mr-3">
                                <i class="fas fa-play-circle text-2xl text-orange-500"></i>
                            </div>
                            <div>
                                <h3 class="font-medium mb-1">Quick Surya Namaskar Demo</h3>
                                <p class="text-sm opacity-80">Short demonstration of all 12 poses</p>
                                <div class="mt-1 text-xs opacity-70">
                                    <span><i class="fas fa-clock mr-1"></i> 1 min</span>
                                </div>
                            </div>
                        </div>
                    </a>
                    
                    <!-- Video Link 2 -->
                    <a href="https://www.youtube.com/watch?v=8AakYeM23sI" target="_blank" rel="noopener" class="video-link">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 mr-3">
                                <i class="fas fa-play-circle text-2xl text-orange-500"></i>
                            </div>
                            <div>
                                <h3 class="font-medium mb-1">Guided Surya Namaskar Practice</h3>
                                <p class="text-sm opacity-80">Full guided session with proper breathing</p>
                                <div class="mt-1 text-xs opacity-70">
                                    <span><i class="fas fa-clock mr-1"></i> 10 min</span>
                                </div>
                            </div>
                        </div>
                    </a>
                    
                    <!-- Video Link 3 -->
                    <a href="https://www.youtube.com/watch?v=gC_L9qAHVJ8" target="_blank" rel="noopener" class="video-link">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 mr-3">
                                <i class="fas fa-play-circle text-2xl text-orange-500"></i>
                            </div>
                            <div>
                                <h3 class="font-medium mb-1">Detailed Surya Namaskar Tutorial</h3>
                                <p class="text-sm opacity-80">Learn proper form and alignment for each pose</p>
                                <div class="mt-1 text-xs opacity-70">
                                    <span><i class="fas fa-clock mr-1"></i> 15 min</span>
                                </div>
                            </div>
                        </div>
                    </a>
                </div>
                
                <div class="mt-6 bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-medium text-blue-800 mb-2"><i class="fas fa-info-circle mr-2"></i>Video Tips</h3>
                    <ul class="text-sm text-blue-700 space-y-1 list-disc list-inside">
                        <li>Click any link to open the video in your browser</li>
                        <li>Videos will open in a new tab</li>
                        <li>Choose the video that matches your experience level</li>
                        <li>Practice along with the guided videos for best results</li>
                    </ul>
                </div>
            </div>

            <!-- Stats Tab -->
            <div id="stats" class="tab-content">
                <!-- Today's Stats -->
                <div class="mb-4 p-4 rounded-xl shadow bg-gradient-to-r from-orange-200 to-yellow-100 flex items-center justify-between">
                    <div>
                        <div class="text-xs text-gray-500 mb-1">Today, Apr 18, 2025</div>
                        <div class="text-lg font-bold text-orange-700" id="stat-today-rounds">0</div>
                        <div class="text-xs text-gray-500">Rounds Completed Today</div>
                    </div>
                </div>
                <!-- Overall Stats Cards (smaller) -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <div class="rounded-lg shadow bg-gradient-to-br from-orange-100 to-yellow-50 p-2 flex flex-col items-center">
                        <div class="text-2xl mb-1"><i class="fas fa-sun text-orange-400"></i></div>
                        <div class="text-lg font-bold text-orange-600" id="stat-total-rounds">0</div>
                        <div class="text-xs text-gray-500 mt-0.5">Total Rounds</div>
                    </div>
                    <div class="rounded-lg shadow bg-gradient-to-br from-orange-100 to-yellow-50 p-2 flex flex-col items-center">
                        <div class="text-2xl mb-1"><i class="fas fa-calendar-day text-orange-400"></i></div>
                        <div class="text-lg font-bold text-orange-600" id="stat-total-days">0</div>
                        <div class="text-xs text-gray-500 mt-0.5">Practice Days</div>
                    </div>
                    <div class="rounded-lg shadow bg-gradient-to-br from-orange-100 to-yellow-50 p-2 flex flex-col items-center">
                        <div class="text-2xl mb-1"><i class="fas fa-fire text-orange-500"></i></div>
                        <div class="text-lg font-bold text-orange-600" id="stat-streak">0</div>
                        <div class="text-xs text-gray-500 mt-0.5">Current Streak</div>
                    </div>
                    <div class="rounded-lg shadow bg-gradient-to-br from-orange-100 to-yellow-50 p-2 flex flex-col items-center">
                        <div class="text-2xl mb-1"><i class="fas fa-trophy text-yellow-500"></i></div>
                        <div class="text-lg font-bold text-orange-600" id="stat-best-streak">0</div>
                        <div class="text-xs text-gray-500 mt-0.5">Best Streak</div>
                    </div>
                </div>
                <div class="bg-white/80 dark:bg-gray-800/80 p-4 rounded-2xl shadow mb-4">
                    <div class="flex items-center gap-2 mb-2">
                        <i class="fas fa-check-circle text-orange-500"></i>
                        <span class="text-sm font-semibold text-gray-700 dark:text-gray-200">Habit Tracker</span>
                        <button id="habit-plus-btn" class="ml-2 bg-teal-600 hover:bg-teal-700 text-white !text-white !bg-teal-600 !hover:bg-teal-700 rounded-full w-6 h-6 flex items-center justify-center text-base shadow transition border-2 border-teal-700" title="Mark today as completed"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="habit-grid" class="grid grid-cols-7 gap-1 mb-2"></div>
                    <div class="text-xs text-gray-400 mt-1">Tap a day to mark/unmark as practiced.</div>
                </div>
                <div id="stats-motivation" class="text-center text-orange-700 font-semibold mt-4"></div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="text-center text-gray-600 pb-4">
        <p>Made with <i class="fas fa-heart text-red-500"></i> by <a href="mailto:tiwarinaren@gmail.com" class="text-orange-500 hover:text-orange-600 transition duration-300">Naren Tiwari</a></p>
    </div>

    <!-- Hidden Audio Players with iOS Compatibility -->
<audio id="transition-sound" src="assets/soft_beep.mp3" preload="auto" playsinline></audio>
<audio id="inhale-sound" src="assets/inhale.mp3" preload="auto" playsinline></audio>
<audio id="exhale-sound" src="assets/exhale.mp3" preload="auto" playsinline></audio>
<audio id="hold-sound" src="assets/hold.mp3" preload="auto" playsinline></audio>
<audio id="left-leg-forward-sound" src="assets/left_leg_forward.mp3" preload="auto" playsinline></audio>
<audio id="right-leg-forward-sound" src="assets/right_leg_forward.mp3" preload="auto" playsinline></audio>

<script>
    // --- Pose Data ---
    const poses = [
        { name: "Pranamasana", image: "assets/Surya-Namaskar-step-1.jpg", instruction: "Stand erect, feet together. Join palms at chest center.", duration: 5, breathing: "Exhale / Normal" },
        { name: "Hasta Uttanasana", image: "assets/Surya-Namaskar-step-2.jpg", instruction: "Inhale, raise arms, arch back gently.", duration: 5, breathing: "Inhale" },
        { name: "Hasta Padasana", image: "assets/Surya-Namaskar-step-3.jpg", instruction: "Exhale, bend forward from hips, hands to feet.", duration: 5, breathing: "Exhale" },
        { name: "Ashwa Sanchalanasana", image: "assets/Surya-Namaskar-step-4.jpg", instruction: "Inhale, step right leg back, knee down, look up.", duration: 5, breathing: "Inhale", specialAudio: "left-leg-forward-sound", specialText: "LEFT LEG FORWARD" },
        { name: "Parvatasana", image: "assets/Surya-Namaskar-step-5.jpg", instruction: "Exhale, step left leg back, lift hips (inverted V).", duration: 5, breathing: "Exhale" },
        { name: "Ashtanga Namaskara", image: "assets/Surya-Namaskar-step-6.jpg", instruction: "Hold breath, lower knees, chest, chin.", duration: 5, breathing: "Hold Breath" },
        { name: "Bhujangasana", image: "assets/Surya-Namaskar-step-7.jpg", instruction: "Inhale, slide forward, lift chest (cobra).", duration: 5, breathing: "Inhale" },
        { name: "Parvatasana", image: "assets/Surya-Namaskar-step-5.jpg", instruction: "Exhale, lift hips back to inverted V.", duration: 5, breathing: "Exhale" },
        { name: "Ashwa Sanchalanasana", image: "assets/Surya-Namaskar-step-9.jpg", instruction: "Inhale, step right foot forward, left knee down.", duration: 5, breathing: "Inhale", specialAudio: "right-leg-forward-sound", specialText: "RIGHT LEG FORWARD" },
        { name: "Hasta Padasana", image: "assets/Surya-Namaskar-step-3.jpg", instruction: "Exhale, step left foot forward, bend forward.", duration: 5, breathing: "Exhale" },
        { name: "Hasta Uttanasana", image: "assets/Surya-Namaskar-step-2.jpg", instruction: "Inhale, raise arms, arch back.", duration: 5, breathing: "Inhale" },
        { name: "Pranamasana", image: "assets/Surya-Namaskar-step-1.jpg", instruction: "Exhale, return to prayer pose.", duration: 5, breathing: "Exhale" },
    ];

    // Default Settings (will be overridden by localStorage if available)
    // Get initial durations FROM the poses array itself
    const defaultSettings = {
        poseDurations: poses.map(p => p.duration),
        totalRounds: 5,
        voiceGuidance: true,
        transitionSounds: true
    };

    // --- Global State ---
    let timerInterval = null;
    let poseTimeRemaining = 0;
    let isRunning = false;
    let currentPoseIndex = 0;
    let currentRound = 1;
    let totalRounds = defaultSettings.totalRounds;
    let voiceGuidanceEnabled = defaultSettings.voiceGuidance;
    let transitionSoundsEnabled = defaultSettings.transitionSounds;
    const totalPoses = poses.length;
    const SETTINGS_KEY = 'suryaNamaskarSettings'; // Key for localStorage

    // --- DOM Elements ---
    const tabBtns = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const timerDisplay = document.getElementById('timer');
    const playPauseBtn = document.getElementById('play-pause-btn');
    const playPauseIcon = document.getElementById('play-pause-icon');
    const resetBtn = document.getElementById('reset-btn');
    const roundCountDisplay = document.getElementById('round-count');
    const totalRoundsDisplay = document.getElementById('total-rounds-display');
    const progressBar = document.getElementById('pose-progress');
    const poseSlidersContainer = document.getElementById('pose-sliders-container');
    const roundsSelect = document.getElementById('rounds-select');
    const voiceGuidanceCheckbox = document.getElementById('voice-guidance');
    const transitionSoundsCheckbox = document.getElementById('transition-sounds');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const settingsSavedMsg = document.getElementById('settings-saved-msg');

    // Guided Practice UI Elements
    const currentPoseNumberDisplay = document.getElementById('current-pose-number');
    const currentPoseNameDisplay = document.getElementById('current-pose-name');
    const currentPoseImage = document.getElementById('current-pose-image');
    const currentPoseInstruction = document.getElementById('current-pose-instruction');
    const currentBreathingCue = document.getElementById('current-breathing-cue');
    const nextPoseNumberDisplay = document.getElementById('next-pose-number');
    const nextPoseNameDisplay = document.getElementById('next-pose-name');
    const nextPoseImage = document.getElementById('next-pose-image');
    const nextPoseInstruction = document.getElementById('next-pose-instruction');
    const nextBreathingCue = document.getElementById('next-breathing-cue');

    // --- Audio Elements --- Get references
    const transitionSound = document.getElementById('transition-sound');
    const inhaleSound = document.getElementById('inhale-sound');
    const exhaleSound = document.getElementById('exhale-sound');
    const holdSound = document.getElementById('hold-sound');

    // --- Functions ---
    
    // Helper function to play sounds
    function playSound(audioElement) {
        if (!audioElement) return;
        
        // Reset the audio to the beginning
        audioElement.currentTime = 0;
        
        // Play the sound with error handling
        const playPromise = audioElement.play();
        
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error('Error playing sound:', error);
            });
        }
    }

    // PWA Service Worker Registration
    function registerServiceWorker() {
        if ('serviceWorker' in navigator) {
             // Make sure the path is correct relative to your HTML file's location
            navigator.serviceWorker.register('sw.js') // Use 'sw.js' if it's in the same directory
                .then(registration => {
                    console.log('Service Worker registered with scope:', registration.scope);
                })
                .catch(error => {
                    console.error('Service Worker registration failed:', error);
                });
        }
    }
    
    // Preload audio files for iOS compatibility
    function preloadAudioFiles() {
        // Get all audio elements
        const audioElements = [
            transitionSound,
            inhaleSound,
            exhaleSound,
            holdSound,
            document.getElementById('left-leg-forward-sound'),
            document.getElementById('right-leg-forward-sound')
        ];
        
        // Force load each audio file
        audioElements.forEach(audio => {
            // Create a temporary function to handle user interaction requirement on iOS
            const loadAudio = () => {
                // Load the audio file
                audio.load();
                
                // Set volume to 0 temporarily
                const originalVolume = audio.volume;
                audio.volume = 0;
                
                // Try to play and immediately pause to "unlock" audio on iOS
                audio.play().then(() => {
                    // Successfully played, now pause and restore volume
                    audio.pause();
                    audio.currentTime = 0;
                    audio.volume = originalVolume;
                    console.log(`Preloaded audio: ${audio.src.split('/').pop()}`);
                }).catch(error => {
                    // If it fails, that's okay - we'll try again when needed
                    console.log(`Could not preload audio: ${error.message}`);
                    audio.volume = originalVolume;
                });
            };
            
            // Call the function
            loadAudio();
        });
    }

    // Tab Switching
    function activateTab(tabId) {
        tabBtns.forEach(b => {
            const isCurrent = b.getAttribute('data-tab') === tabId;
            b.classList.toggle('text-orange-600', isCurrent);
            b.classList.toggle('border-orange-500', isCurrent);
            b.classList.toggle('text-gray-500', !isCurrent);
            b.classList.toggle('border-transparent', !isCurrent);
        });
        tabContents.forEach(content => {
            content.classList.toggle('active', content.id === tabId);
        });
    }

    // Timing Tab: Create/Update Sliders
    function initializeTimingSliders() {
        poseSlidersContainer.innerHTML = ''; // Clear existing
        // Use the current durations stored in the poses array
        poses.forEach((pose, index) => {
            const sliderId = `pose${index + 1}-time`;
            const valueId = `pose${index + 1}-value`;
            const div = document.createElement('div');
            div.classList.add('mb-3');
            div.innerHTML = `
                <label for="${sliderId}" class="block text-sm text-gray-600 mb-1">${index + 1}. ${pose.name}</label>
                <input type="range" min="2" max="30" value="${pose.duration}" class="w-full" id="${sliderId}" data-index="${index}">
                <div class="flex justify-between text-xs text-gray-500 mt-1 px-1">
                    <span>2s</span>
                    <span id="${valueId}" class="font-medium text-orange-600">${pose.duration}s</span>
                    <span>30s</span>
                </div>
            `;
            poseSlidersContainer.appendChild(div);

            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(valueId);
            slider.addEventListener('input', () => {
                valueDisplay.textContent = `${slider.value}s`;
                valueDisplay.classList.add('text-orange-600');
            });
        });
    }

    // --- Settings Load/Save ---
    function loadSettings() {
         const savedSettings = localStorage.getItem(SETTINGS_KEY);
         let settings;
         let loadedDurations = null;

         if (savedSettings) {
             try {
                settings = JSON.parse(savedSettings);
                // Validate loaded settings structure
                if (settings && settings.poseDurations && settings.poseDurations.length === totalPoses) {
                    loadedDurations = settings.poseDurations;
                } else {
                    console.warn("Invalid settings format in localStorage, using defaults.");
                    settings = null; // Force using defaults below
                    localStorage.removeItem(SETTINGS_KEY);
                }
             } catch (e) {
                 console.error("Error parsing settings from localStorage, using defaults:", e);
                 settings = null;
                 localStorage.removeItem(SETTINGS_KEY);
             }
         }

         // Use loaded settings or defaults
         const finalSettings = settings || { ...defaultSettings, poseDurations: poses.map(p => p.duration) }; // Ensure fresh default durations if needed

         // Apply settings to the main 'poses' array and global vars
         poses.forEach((pose, index) => {
             // Validate duration: must be between 2 and 30
             const loadedDuration = parseInt(finalSettings.poseDurations[index], 10);
             pose.duration = Math.max(2, Math.min(30, isNaN(loadedDuration) ? 5 : loadedDuration)); // Fallback to 5 if NaN
         });
         totalRounds = finalSettings.totalRounds || defaultSettings.totalRounds;
         voiceGuidanceEnabled = finalSettings.voiceGuidance !== undefined ? finalSettings.voiceGuidance : defaultSettings.voiceGuidance;
         transitionSoundsEnabled = finalSettings.transitionSounds !== undefined ? finalSettings.transitionSounds : defaultSettings.transitionSounds;

         // Update UI elements in Timing Tab to reflect loaded/default state
         roundsSelect.value = totalRounds;
         voiceGuidanceCheckbox.checked = voiceGuidanceEnabled;
         transitionSoundsCheckbox.checked = transitionSoundsEnabled;

         // Update UI elements in Practice Tab
         totalRoundsDisplay.textContent = totalRounds;

         // Re-initialize sliders AFTER updating pose durations
         initializeTimingSliders();

         console.log("Settings Applied:", { poseDurations: poses.map(p=>p.duration), totalRounds, voiceGuidanceEnabled, transitionSoundsEnabled });
    }

    function saveSettings() {
        const currentDurations = [];
        poses.forEach((_, index) => {
            const slider = document.getElementById(`pose${index + 1}-time`);
            // Read directly from slider, validate, and update the main poses array
            const duration = Math.max(2, Math.min(30, slider ? parseInt(slider.value, 10) : 5)); // Use 5 as fallback if slider not found
            poses[index].duration = duration;
            currentDurations.push(duration);
        });

        const selectedRounds = parseInt(roundsSelect.value, 10);
        const voiceChecked = voiceGuidanceCheckbox.checked;
        const soundsChecked = transitionSoundsCheckbox.checked;

        const settingsToSave = {
            poseDurations: currentDurations, // Save the validated durations
            totalRounds: selectedRounds,
            voiceGuidance: voiceChecked,
            transitionSounds: soundsChecked
        };

        try {
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settingsToSave));
            console.log("Settings Saved:", settingsToSave);

            // Update global state variables used by practice tab
            totalRounds = selectedRounds;
            voiceGuidanceEnabled = voiceChecked;
            transitionSoundsEnabled = soundsChecked;

            // Update UI in Practice Tab immediately
            totalRoundsDisplay.textContent = totalRounds;

            resetPractice(); // Reset practice state to reflect new settings

            settingsSavedMsg.textContent = 'Settings Saved!';
            setTimeout(() => { settingsSavedMsg.textContent = ''; }, 2000);

        } catch (e) {
            console.error("Error saving settings to localStorage:", e);
            settingsSavedMsg.textContent = 'Error saving settings!';
            setTimeout(() => { settingsSavedMsg.textContent = ''; }, 3000);
        }
    }

    // --- Enhanced Audio Playback Function for iOS Compatibility ---
    function playSound(audioElement) {
        if (!audioElement) return;
        
        // Reset audio element
        audioElement.pause();
        audioElement.currentTime = 0;
        
        // Create a user interaction promise for iOS
        const playPromise = audioElement.play();
        
        // Handle play() promise to catch errors properly
        if (playPromise !== undefined) {
            playPromise
                .then(() => {
                    // Playback started successfully
                    console.log(`Playing sound: ${audioElement.src.split('/').pop()}`);
                })
                .catch(error => {
                    // Auto-play was prevented or other error
                    console.error("Audio play failed:", error);
                    
                    // For iOS, try playing again with a slight delay
                    setTimeout(() => {
                        audioElement.play()
                            .catch(retryError => console.error("Retry audio play failed:", retryError));
                    }, 100);
                });
        }
    }

    // --- Play Breathing Cue (Fixed) ---
    function playBreathingCue(poseIndex) {
        if (!voiceGuidanceEnabled) return; // Only play if enabled
        
        // Force a small delay to ensure audio context is ready
        setTimeout(() => {
            const poseData = poses[poseIndex];
            const breathingCue = poseData?.breathing?.toLowerCase() || '';
            console.log(`Playing breathing cue for pose ${poseIndex + 1}: ${breathingCue}`);
            
            // Make sure audio elements are properly loaded
            inhaleSound.load();
            exhaleSound.load();
            holdSound.load();
            
            // Check if this pose has special audio that should be played first
            if (poseData.specialAudio) {
                // Special audio is handled in updatePoseDisplay function
                // We'll add a delay before playing the breathing cue
                setTimeout(() => {
                    playBreathingSound(breathingCue);
                }, 1500); // Delay breathing cue by 1.5 seconds to allow special audio to finish
            } else {
                // Play breathing cue immediately
                playBreathingSound(breathingCue);
            }
        }, 100); // Small delay to ensure audio context is ready
    }
    
    // Helper function to play the appropriate breathing sound
    function playBreathingSound(breathingCue) {
        if (breathingCue.includes('inhale')) {
            console.log('Playing inhale sound');
            playSound(inhaleSound);
        } else if (breathingCue.includes('exhale')) {
            console.log('Playing exhale sound');
            playSound(exhaleSound);
        } else if (breathingCue.includes('hold')) {
            console.log('Playing hold sound');
            playSound(holdSound);
        } else {
            console.log('No matching breathing cue found');
        }
    }

    // --- Smoother Visual Transitions for Practice Tab ---
    function fadeTransition(element, newSrc, callback) {
        element.style.transition = 'opacity 0.4s';
        element.style.opacity = 0;
        setTimeout(() => {
            if (newSrc) element.src = newSrc;
            element.style.opacity = 1;
            if (callback) setTimeout(callback, 400);
        }, 400);
    }

    // Guided Practice: Update Pose Display
    function updatePoseDisplay(isInitial = false) {
        const currentPoseData = poses[currentPoseIndex];
        const nextPoseIndex = (currentPoseIndex + 1) % totalPoses;
        const nextPoseData = poses[nextPoseIndex];

        // Fade transition for current pose image
        fadeTransition(currentPoseImage, currentPoseData.image);
        // Fade transition for next pose image
        fadeTransition(nextPoseImage, nextPoseData.image);
        
        // Handle special instructions for poses 4 and 9
        const specialInstructionContainer = document.getElementById('special-instruction-container');
        const specialInstructionText = document.getElementById('special-instruction-text');
        
        // Check if current pose has special text (poses 4 and 9)
        if (currentPoseData.specialText) {
            // Update the special instruction text
            specialInstructionText.textContent = currentPoseData.specialText;
            // Set text color to a red shade matching the app theme
            specialInstructionText.style.color = '#dc2626'; // Tailwind red-600
            // Show the special instruction container
            specialInstructionContainer.classList.remove('hidden');
            
            // Play special audio if available, enabled, and not in initial display
            if (!isInitial && currentPoseData.specialAudio && voiceGuidanceEnabled) {
                const specialAudio = document.getElementById(currentPoseData.specialAudio);
                if (specialAudio) {
                    // Play the special audio before the breathing cue
                    specialAudio.load();
                    playSound(specialAudio);
                }
            }
        } else {
            // Hide the special instruction container for other poses
            specialInstructionContainer.classList.add('hidden');
        }

        // Current Pose
        currentPoseNumberDisplay.textContent = currentPoseIndex + 1;
        currentPoseNameDisplay.textContent = currentPoseData.name;
        currentPoseInstruction.textContent = currentPoseData.instruction;
        currentBreathingCue.textContent = currentPoseData.breathing;

        // Next Pose
        nextPoseNumberDisplay.textContent = nextPoseIndex + 1;
        nextPoseNameDisplay.textContent = nextPoseData.name;
        nextPoseInstruction.textContent = nextPoseData.instruction;
        nextBreathingCue.textContent = nextPoseData.breathing;

        // Update timer display and progress bar
        poseTimeRemaining = currentPoseData.duration;
        timerDisplay.textContent = poseTimeRemaining.toString().padStart(2, '0');
        progressBar.style.width = '100%';

        // Update round display
        roundCountDisplay.textContent = currentRound;
    }

    // Guided Practice: Timer Tick
    function timerTick() {
         if (!isRunning) return;

        poseTimeRemaining--;
        timerDisplay.textContent = poseTimeRemaining.toString().padStart(2, '0');

        // Update progress bar using the correct duration from the poses array
         // *** FIX: Use the duration directly from the updated poses array ***
        const currentPoseDuration = poses[currentPoseIndex].duration; // Should be valid (>=2)
        const progressPercent = Math.max(0, (poseTimeRemaining / currentPoseDuration) * 100);
        progressBar.style.width = `${progressPercent}%`;

        // Check if pose duration reached
        if (poseTimeRemaining <= 0) {
            moveToNextPose();
        }
    }

    // Guided Practice: Move to Next Pose (Enhanced for consistent audio)
    function moveToNextPoseWithStats() {
        // Play transition sound BEFORE updating the index if enabled
        if (transitionSoundsEnabled) {
            playSound(transitionSound);
        }

        // Small delay to ensure transition sound completes before voice guidance
        setTimeout(() => {
            currentPoseIndex++;
            if (currentPoseIndex >= totalPoses) {
                currentPoseIndex = 0; // Wrap around poses
                currentRound++;
                if (currentRound > totalRounds) {
                    alert(`Practice Complete! You finished ${totalRounds} rounds.`);
                    recordPractice(totalRounds);
                    resetPractice();
                    return; // Stop the timer loop
                } else {
                    if (voiceGuidanceEnabled) console.log(`Starting Round ${currentRound}`);
                }
            }

            // Update display for the NEW pose
            updatePoseDisplay();

            // Play breathing cue for the NEW pose AFTER display update with a slight delay
            // This ensures the audio context has time to reset between sounds
            setTimeout(() => {
                if (voiceGuidanceEnabled) {
                    console.log(`Playing breathing cue for pose ${currentPoseIndex + 1} (${poses[currentPoseIndex].name})`);
                    playBreathingCue(currentPoseIndex);
                }
            }, 300);

            // Reset the timer interval for the new pose's duration
            clearInterval(timerInterval); // Clear old interval
            if (isRunning) { // Start new interval only if still running
                timerInterval = setInterval(timerTick, 1000);
            }
        }, 200); // Small delay to separate transition sound from voice guidance
    }

    // Guided Practice: Toggle Play/Pause
    function togglePlayPause() {
        isRunning = !isRunning;
        if (!isRunning) {
            // Pause
            clearInterval(timerInterval);
            timerInterval = null;
            playPauseBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
            playPauseBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            playPauseIcon.classList.remove('fa-pause');
            playPauseIcon.classList.add('fa-play');
            resetBtn.disabled = false;
            resetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        } else {
            // Play
            playPauseBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            playPauseBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
            playPauseIcon.classList.remove('fa-play');
            playPauseIcon.classList.add('fa-pause');
            resetBtn.disabled = true;
            resetBtn.classList.add('opacity-50', 'cursor-not-allowed');

            // Get current pose duration
            const currentPoseDuration = poses[currentPoseIndex].duration;
            // If resuming, keep current time; otherwise, set to full duration
            if (!(poseTimeRemaining > 0 && poseTimeRemaining < currentPoseDuration)) {
                poseTimeRemaining = currentPoseDuration;
            }

            timerDisplay.textContent = poseTimeRemaining.toString().padStart(2, '0');
            const progressPercent = Math.max(0, (poseTimeRemaining / currentPoseDuration) * 100);
            progressBar.style.width = `${progressPercent}%`;

            // Play breathing cue for the first pose when starting
            if (currentPoseIndex === 0 && poseTimeRemaining === currentPoseDuration) {
                if (voiceGuidanceEnabled) console.log(`Starting Round ${currentRound}: ${poses[currentPoseIndex].name}`);
                playBreathingCue(currentPoseIndex);
            } else if (voiceGuidanceEnabled) {
                console.log(`Resuming: ${poses[currentPoseIndex].name}`);
            }

            // Start the countdown
            clearInterval(timerInterval);
            timerInterval = setInterval(timerTick, 1000);
        }
    }

    // Reset Practice
    function resetPractice() {
        isRunning = false;
        clearInterval(timerInterval);
        timerInterval = null;
        currentPoseIndex = 0;
        currentRound = 1;
        updatePoseDisplay(true);
        // Reset button styles
        playPauseBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
        playPauseBtn.classList.add('bg-green-500', 'hover:bg-green-600');
        playPauseIcon.classList.remove('fa-pause');
        playPauseIcon.classList.add('fa-play');
        resetBtn.disabled = false;
        resetBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    // --- Enhanced Dark Mode Toggle Function ---
    function toggleDarkMode() {
        const body = document.body;
        const themeIcon = document.getElementById('theme-icon');
        const appContainer = document.getElementById('app-container');
        const currentTheme = body.getAttribute('data-theme');
        
        // Apply theme to body and app container
        if (currentTheme === 'light') {
            // Switch to dark mode
            body.setAttribute('data-theme', 'dark');
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
            localStorage.setItem('theme', 'dark');
            
            // Force refresh all pose cards
            document.querySelectorAll('.pose-card').forEach(card => {
                card.style.backgroundColor = 'var(--bg-accent)';
            });
            
            // Ensure app container has proper background
            appContainer.style.backgroundColor = 'var(--bg-secondary)';
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (!btn.classList.contains('text-orange-600')) {
                    btn.style.color = 'var(--text-secondary)';
                }
            });
        } else {
            // Switch to light mode
            body.setAttribute('data-theme', 'light');
            themeIcon.classList.remove('fa-sun');
            themeIcon.classList.add('fa-moon');
            localStorage.setItem('theme', 'light');
            
            // Force refresh all pose cards
            document.querySelectorAll('.pose-card').forEach(card => {
                card.style.backgroundColor = 'var(--bg-secondary)';
            });
            
            // Ensure app container has proper background
            appContainer.style.backgroundColor = 'var(--bg-secondary)';
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                if (!btn.classList.contains('text-orange-600')) {
                    btn.style.color = '';
                }
            });
        }
        
        // Force redraw of all elements with transition
        document.querySelectorAll('.pose-image-container, .video-link, .rounded-lg').forEach(el => {
            el.style.transition = 'none';
            el.offsetHeight; // Trigger reflow
            el.style.transition = '';
        });
    }
    
    // --- Enhanced Load Theme Preference ---
    function loadThemePreference() {
        const savedTheme = localStorage.getItem('theme');
        const themeIcon = document.getElementById('theme-icon');
        const appContainer = document.getElementById('app-container');
        
        // Apply the saved theme or default to light
        if (savedTheme === 'dark') {
            // Apply dark theme
            document.body.setAttribute('data-theme', 'dark');
            themeIcon.classList.remove('fa-moon');
            themeIcon.classList.add('fa-sun');
            
            // Apply dark mode to specific elements
            setTimeout(() => {
                // Use setTimeout to ensure DOM is fully loaded
                document.querySelectorAll('.pose-card').forEach(card => {
                    card.style.backgroundColor = 'var(--bg-accent)';
                });
                
                if (appContainer) {
                    appContainer.style.backgroundColor = 'var(--bg-secondary)';
                }
                
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    if (!btn.classList.contains('text-orange-600')) {
                        btn.style.color = 'var(--text-secondary)';
                    }
                });
                
                // Apply dark mode to blue info boxes
                document.querySelectorAll('.bg-blue-50').forEach(box => {
                    box.style.backgroundColor = 'rgba(30, 58, 138, 0.3)';
                });
                
                document.querySelectorAll('.text-blue-700, .text-blue-800').forEach(text => {
                    text.style.color = '#93c5fd';
                });
            }, 0);
        } else {
            // Apply light theme
            document.body.setAttribute('data-theme', 'light');
            themeIcon.classList.remove('fa-sun');
            themeIcon.classList.add('fa-moon');
        }
    }

    // --- Speed Presets for Timing Tab ---
    function addSpeedPresets() {
        const container = document.createElement('div');
        container.className = 'flex gap-2 mb-4';
        const presets = [
            { name: 'Beginner', values: [8,8,8,8,8,8,8,8,8,8,8,8] },
            { name: 'Intermediate', values: [5,5,5,5,5,5,5,5,5,5,5,5] },
            { name: 'Advanced', values: [3,3,3,3,3,3,3,3,3,3,3,3] }
        ];
        presets.forEach(preset => {
            const btn = document.createElement('button');
            btn.textContent = preset.name;
            btn.className = 'flex-1 bg-orange-100 hover:bg-orange-200 text-orange-700 font-semibold py-2 rounded transition';
            btn.addEventListener('click', () => {
                poses.forEach((pose, i) => {
                    pose.duration = preset.values[i];
                    const slider = document.getElementById(`pose${i+1}-time`);
                    const value = document.getElementById(`pose${i+1}-value`);
                    if (slider && value) {
                        slider.value = preset.values[i];
                        value.textContent = `${preset.values[i]}s`;
                    }
                });
            });
            container.appendChild(btn);
        });
        poseSlidersContainer.parentNode.insertBefore(container, poseSlidersContainer);
    }

    // --- Stats & Progress Tracking ---
    const STATS_KEY = 'suryaNamaskarStats';

    function getTodayStr() {
        const d = new Date();
        return d.toISOString().slice(0,10); // YYYY-MM-DD
    }

    function loadStats() {
        let stats = localStorage.getItem(STATS_KEY);
        if (stats) {
            try { stats = JSON.parse(stats); } catch { stats = null; }
        }
        if (!stats || typeof stats !== 'object') {
            stats = { totalRounds: 0, days: {}, bestStreak: 0 };
        }
        return stats;
    }

    function saveStats(stats) {
        localStorage.setItem(STATS_KEY, JSON.stringify(stats));
    }

    function updateStatsUI() {
        const stats = loadStats();
        // Total rounds
        document.getElementById('stat-total-rounds').textContent = stats.totalRounds || 0;
        // Days practiced
        const days = Object.keys(stats.days || {});
        document.getElementById('stat-total-days').textContent = days.length;
        // Streaks
        let streak = 0, best = stats.bestStreak || 0;
        let today = new Date();
        let d = new Date(today);
        while (stats.days[getTodayStrFromDate(d)]) {
            streak++;
            d.setDate(d.getDate()-1);
        }
        document.getElementById('stat-streak').textContent = streak;
        document.getElementById('stat-best-streak').textContent = best;
        // Habit grid
        renderHabitGrid(stats.days || {});
    }

    function getTodayStrFromDate(date) {
        return date.toISOString().slice(0,10);
    }

    function renderHabitGrid(daysObj) {
        const grid = document.getElementById('habit-grid');
        grid.innerHTML = '';
        const today = new Date();
        let d = new Date(today);
        d.setDate(d.getDate() - 41); // Show last 6 weeks (42 days)
        for (let i=0; i<42; i++) {
            const dayStr = getTodayStrFromDate(d);
            const marked = !!daysObj[dayStr];
            const cell = document.createElement('div');
            cell.className = 'w-6 h-6 rounded flex items-center justify-center text-xs font-bold cursor-pointer ' + (marked ? 'bg-orange-400 text-white' : 'bg-gray-200 text-gray-400 hover:bg-orange-100');
            cell.title = dayStr;
            cell.textContent = d.getDate();
            cell.addEventListener('click', () => {
                toggleHabitDay(dayStr);
            });
            grid.appendChild(cell);
            d.setDate(d.getDate()+1);
        }
    }

    function toggleHabitDay(dayStr) {
        const stats = loadStats();
        if (stats.days[dayStr]) {
            delete stats.days[dayStr];
        } else {
            stats.days[dayStr] = true;
        }
        saveStats(stats);
        updateStatsUI();
    }

    function recordPractice(rounds) {
        const stats = loadStats();
        stats.totalRounds = (stats.totalRounds || 0) + rounds;
        const today = getTodayStr();
        stats.days[today] = true;
        // Set today's rounds to the actual number completed from Practice page
        if (!stats.todayRounds) stats.todayRounds = {};
        stats.todayRounds[today] = rounds;
        // Update streaks
        let streak = 0;
        let d = new Date();
        while (stats.days[getTodayStrFromDate(d)]) {
            streak++;
            d.setDate(d.getDate()-1);
        }
        if (!stats.bestStreak || streak > stats.bestStreak) stats.bestStreak = streak;
        saveStats(stats);
        updateStatsUI();
        updateTodayStatsUI();
    }

    // --- Today's Stats & Habit + Button Logic ---
    function updateTodayStatsUI() {
        const stats = loadStats();
        const today = getTodayStr();
        // Count rounds completed today (if tracked)
        let todayRounds = stats.todayRounds || {};
        let rounds = todayRounds[today] || 0;
        document.getElementById('stat-today-rounds').textContent = rounds;
        // Update + button state (disable if already marked)
        const markBtn = document.getElementById('mark-today-btn');
        if (markBtn) {
            if (stats.days[today]) {
                markBtn.disabled = true;
                markBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                markBtn.disabled = false;
                markBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }
    }

    function markTodayCompleted() {
        const stats = loadStats();
        const today = getTodayStr();
        // Mark today in habit only (do not increment rounds)
        stats.days[today] = true;
        // Do NOT increment stats.todayRounds[today] here
        // Update streaks
        let streak = 0;
        let d = new Date();
        while (stats.days[getTodayStrFromDate(d)]) {
            streak++;
            d.setDate(d.getDate()-1);
        }
        if (!stats.bestStreak || streak > stats.bestStreak) stats.bestStreak = streak;
        saveStats(stats);
        updateStatsUI();
        updateTodayStatsUI();
    }

    // Add event listeners for + buttons
    function setupTodayStatsButtons() {
        const markBtn = document.getElementById('mark-today-btn');
        if (markBtn) markBtn.onclick = markTodayCompleted;
        const habitPlusBtn = document.getElementById('habit-plus-btn');
        if (habitPlusBtn) habitPlusBtn.onclick = markTodayCompleted;
    }

    // Call updateStatsUI on tab open
    const statsTabBtn = document.querySelector('[data-tab="stats"]');
    statsTabBtn.addEventListener('click', () => {
        updateStatsUI();
        updateTodayStatsUI();
        setupTodayStatsButtons();
    });

    // --- Event Listeners ---
    tabBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            activateTab(btn.getAttribute('data-tab'));
        });
    });

    // Single play/pause button event listener
    playPauseBtn.addEventListener('click', togglePlayPause);
    resetBtn.addEventListener('click', resetPractice);
    saveSettingsBtn.addEventListener('click', saveSettings);
    
    // Dark mode toggle event listener
    document.getElementById('theme-toggle').addEventListener('click', toggleDarkMode);

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        registerServiceWorker();
        loadSettings(); // Load settings FIRST - this updates the poses array durations
        loadThemePreference(); // Load theme preference
        resetPractice(); // Set initial practice state using the loaded durations
        activateTab('pose-guide'); // Start on the guide tab
        addSpeedPresets(); // Add speed presets to Timing Tab
        
        // Add event listeners for user interaction to preload audio on iOS
        document.addEventListener('click', function audioSetup() {
            preloadAudioFiles();
            // Remove this listener after first interaction
            document.removeEventListener('click', audioSetup);
        }, { once: true });
    });

    // Replace moveToNextPose with moveToNextPoseWithStats
    moveToNextPose = moveToNextPoseWithStats;
</script>
</body>
</html>
